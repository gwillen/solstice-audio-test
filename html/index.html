<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<title>Bucket Brigade</title>
<style>
:root {
  --theme-light: rgb(224, 242, 242);
  --theme-medium: rgb(186, 226, 227);
  --theme-dark: rgb(145, 209, 210);
}
.warning {
  border: 1px dashed red;
  border-radius: 0.25em;
  max-width: 30em;
  margin: 1em;
  padding: 1em;
}
#calibration, #mainInterface, #mainApp {
  display: none;
}
#estQuality {
  border: 1px solid #aaa;
  border-radius: 1em;
  padding: 1em;
  margin: 1em;
  width: calc(100vw - 8em);
  box-sizing: border-box;
}
#est25to75 {
  font-size: 400%;
}
#estLatency {
  font-size: 200%;
}
#activeUsers {
  margin-left: 1em;
}
#chatWindow {
  width: 15em;
  display: flex;
  flex-direction: column;
}
#chatDisplay {
  overflow-y: scroll;
  flex-grow: 1;
  word-wrap: break-word;
}
#chatDisplay > * {
  margin: 0.5em;
}
#chatForm {
  margin: 0;
}
#chatForm > input {
  display: block;
  width: 100%;
}
.chatName {
  font-style: italic;
}
#chatEntry {
  width: 100%;
}
#lostConnectivity {
  display: none;
}
#noAudioInputInstructions {
  display: none;
}
#tutorial > div {
  margin: 1em;
}
#tutorial button {
  margin: 0.25em;
}
#chooseCamera {
  display: none;
}
.headphoneAdvice,
#q_password,
#q_singing_listening,
#q_headphones_present,
#q_wired_headphones_available,
#q_headphones_wired,
#final_attach_wired,
#final_wired_headphones,
#final_detach_wireless,
#final_no_headphones{
  display: none;
}

#volumeCalibration {
  display: none;
}

#backingTrack { display: none; }
#provideLyrics { display: none; }

#crash {
  display: none;
  position: absolute;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  background-color: white;
}
#crashBug {
  display: none;
}
#nameSelector {
  display: none;
}
#latencyCalibrationFailed {
  border: 1px dashed red;
  border-radius: 0.25em;
  margin: 1em;
  padding: 1em;
}
#mixingConsole {
  border: 1px solid black;
}
.consoleChannel {
  margin: 0.5em;
}
.consoleChannel > * {
  display: inline-block;
}
.mixerVolume {
  width: 100px;
  height: 1em;
  margin-left: 0.1em;
}
.mixerVolumeIndicator {
  width: 50%;
  height: 100%;
  background: blue;
  display: inline-block;
}
.channelName {
  width: 16em;
  overflow: hidden;
}
.channelVolumeInput {
  width: 4em;
}
.activeButton {
  background-color: red;
}
input.editing {
  background-color: wheat;
}
input.edited {
  background-color: yellow;
}
#backingVolumeSlider {
  width: 30em;
}
#remainderWindow {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  overflow-y: scroll;
}
#remainderWindow > * {
  margin: 1em;
}
#buckets {
  flex-grow: 1;
  display: none;
  flex-direction: row;
  flex-wrap: wrap;
  margin: 0.5em;
}
#unbucketedUsers {
  flex-grow: 1;
}
.bucket {
  flex-grow: 1;
  display: inline-block;
  border: 1px solid #aaa;
  border-radius: 0.25em;
  margin: 0.5em;
  width: 10em;
  overflow: hidden;
}
.bucket > * {
  margin : 0.5em;
}
.bucketTitle {
  width: 100%;
  border-radius: 0.25em 0.25em 0 0;
  border-bottom: 1px solid #aaa;
  margin: 0;
  display: flex;
  flex-direction: row;
  justify-content: space-between;
}
.bucketTitle > button {
  margin: 0.25em;
  margin-right: 0.5em;
}
.bucketName {
  font-weight: bold;
  margin: 0.25em;
  margin-left: 0.5em;
}
#roundsSettings {
  border: 1px solid black;
  border-radius: 0.25em;
  padding: 0.5em;
}
#runningStatus {
  display: inline-block;
}
#bucketingGuide {
  display: none;
}

body {
  margin: 0;
}

#page {
  width: 100%;
  height: 100%;
  overflow: hidden;
  background-color: var(--theme-light);
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
}

#topbar {
  width: 100%;
  background-color: var(--theme-medium);
  padding-bottom: 0.5em;
}

#toplinks {
  display: flex;
  align-items: baseline;
}

#logoAndName {
  flex-grow: 1;
}

#toplinks > a {
  padding: 1em;
}

.middlePane {
  display: none;
  flex-grow: 1;
  overflow-y: scroll;
}

#middle > * {
  overflow-y: scroll;
}


#noAudioWorklet {
  display: block;
}

#isMobile {
  display: none;
}

.middlePane > * {
  margin: 1em;
}

#booktime > div {
  width: 100%;
  height: 100%;
  display: flex;
  flex-direction: column;
  margin: 0;
}
#booktimeDescription {
  margin: 1em;
}

#calendar {
  flex-grow: 1;
}

#tabrow {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  background-color: var(--theme-medium);
}

#tabbar {
  display: flex;
  align-items: baseline;
}

#tabbar > * {
  padding: 0.5em;
  padding-bottom: 0.35em;
  background-color: var(--theme-dark);
  border-radius: 0.5em 0.5em 0 0;
  border: 1px solid #aaa;
  border-bottom: 0;
  border-left: 0;
}

#tabbar > .activeTab {
  background-color: var(--theme-light);
}

#controlbar {
  display: flex;
  background-color: var(--theme-medium);
  border-top: 1px solid black;
  align-items: baseline;
}


#controlbar > * {
  margin: 1em;
}

#topbar > * {
  margin-left: 1em;
  margin-right: 1em;
}

#bottombar > * {
  margin: 1em;
}

#currentEvent {
  margin-left: 1em;
  margin-bottom: 0.25em;
}

h1 {
 display: inline-block;
 font-family: sans-serif;
}

#mainInterface {
  width: 100%;
  height: 100%;
  margin: 0;
  overflow-y: hidden;
  align-items: stretch;
  display: grid;
  grid-template-rows: min-content auto
}

#bucketsAndChat {
  display: flex;
  flex-direction: row;
  overflow-y: hidden;
}

#toplinks img {
  position: relative;
  top: 1em;
}

#audioOffset {
  width: 2.5em;
  text-align: right;
  margin-right: 0.1em;
}

#rememberedCalibrationInstructions, #latencyCalibrationInstructions {
  display: none;
}

#activeLeader {
  display: none;
}

#lagmute {
  display: none;
}

#spectatorMode {
  display: none;
  padding: 0.5em;
}
#noCameraFound {
  display: none;
}
.participant {
  display: none;
  background-color: white;
  width: 160;
  overflow: hidden;
  min-height: 2em;
  border-radius: 0.25em;
  border: 1px solid #ccc;
}
.dominant-speaker {
  border: 1px solid #0b0;
}
.participantInfo {
  margin: 0.25em;
}
.participant > video {
  width: 160px;
}

#needName, #wrongPassword {
  display: none;
  color: red;
}
#timeoutImminent {
  display: none;
}
#roomfull, #tutorial {
  display: none;
}
#aboveBuckets > * {
  margin-bottom: 1em;
}
#acrossTop {
  padding: 1em;
}

#lyricsEntry {
  position: absolute;
  top: 1em;
  left: 1em;
  border-radius: 0.5em;
  border: 1px solid #aaa;
  width: calc(100vw - 2em);
  height: calc(100vh - 2em);
  background: var(--theme-light);
  z-index: 2;
  display: none;
}
#lyricsEntryBox {
  width: calc(100% - 2em);
  height: calc(100% - 4em);
  margin: 1em;
}
#lyricsEntryBottom {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  margin-right: 1em;
}
#lyricsTooLong {
  color: red;
  display: none;
  margin-right: 1em;
}
#lyricsDisplay {
  width: 100%;
  height: 40vh;
  display: none;
}
#reservePasswordInstructions {
  display: none;
}
#reserveEncodedPassword {
  font-style: italic;
}
</style>
<link rel="stylesheet" href="local-style.css"></link>

<link rel="icon"
      type="image/png"
      href="https://www.jefftk.com/bucket-brigade-logo.png">

<script src="//media.twiliocdn.com/sdk/js/video/releases/2.8.0/twilio-video.min.js"></script>

</head>

<div id=lyricsEntry>
<textarea id=lyricsEntryBox
 placeholder="Paste lyrics here, then press 'OK'."></textarea>
<div id=lyricsEntryBottom>
<div id=lyricsTooLong>Sorry, too many lyrics</div>
<button id=lyricsEntryOk>OK</button>
<button id=lyricsEntryCancel>Cancel</button>
</div>
</div>

<div id=page>

<div id=topbar>
  <div id=toplinks>
    <div id=logoAndName>
    <img src="https://www.jefftk.com/bucket-brigade-logo.png" width=64 height=64>
    <h1 id=instanceName>Bucket Brigade</h1>
    </div>

    <a target="_blank" href="recordings/">Recent Recordings</a>

    <a target="_blank" href="https://github.com/gwillen/solstice-audio-test">Source Code</a>

    <a target="_blank" href="https://github.com/gwillen/solstice-audio-test/issues/new">Report a problem</a>
  </div>

  <div>
    <span id=currentEvent></span>
    <span id=currentUsers></span>
  </div>
</div>

<div id=tabrow>
<div id=tabbar>
  <span class=activeTab id=mainViewTab>Home</span>
  <span id=debugInfoTab>Debug Info</span>
  <span id=debugSettingsTab>Debug Settings</span>
  <span id=advancedSettingsTab>Advanced Settings</span>
  <span id=booktimeTab>Reserve</span>
  <span id=aboutTab>About</span>
</div>

<button id="headerExpandCollapse">&uarr;</button>
</div>

<div id=advancedSettings class=middlePane>
<div>
<h4>Best to leave these alone, since they do affect everyone</h4>

Beats per Minute: <input type=text id=bpm></input>
<p>
Repeats (for rounds): <input type=text id=repeats></input>
<p>
Beats Per Repeat (for rounds): <input type=text id=bpr></input>
<p>
<button id=roundsButtonsUpdate>update</button>
</div>
</div>


<div id=debugSettings class=middlePane>
<div>

  <h3>Settings that only affect you</h3>

    Disable tutorial:
  <input type="checkbox" id="disableTutorial">
  <p>
    Disable latency measurement:
    <input type="checkbox" id="disableLatencyMeasurement">
  <p>
    Server path:
    <input type=text id=serverPath value="/api">
  <p>
    Loopback mode:
    <select id=loopbackMode>
      <option value=none selected>None (default)</option>
      <option value=worklet>Inside worklet process()</option>
      <option value=main>In main app thread</option>
      <option value=server>Server-side</option>
    </select>
  <h3>Settings that affect everyone</h3>
  <i>Leave these alone unless you know what you're doing</i>

<p>

    Disable auto gain:
  <input type="checkbox" id="disableAutoGain">
  <p>
    Disable video during songs:
  <input type="checkbox" id="disableSongVideo">
  <br>
    <div id=clickParams>(Clicks BPM if selected: <input type=text id=clickBPM value=60>)</div>
    <div id=eventTest>
    Test event contents: <input type="text" id=testEventContents>
    Offset (optional): <input type="text" id=testEventOffset>
    <button id=testEventGo>Fire test event</button>
    </div>
    <p>
    Global Volume Control (0-2):
    <input type=text id=globalVolumeControl>
    <p>
    Backing Track Volume Control (0-2):
    <input type=text id=backingVolumeControl>
    <p>
    <div id=mixingConsole>
    <button id=sortConsole>Sort</button>
    </div>
</div>
</div>


<div id=booktime class=middlePane>
<div>
<div id=booktimeDescription>

If no one currently has Bucket Brigade reserved, feel free to use it.

<p>

If you would like to reserve Bucket Brigade, which you are welcome to
do for whatever sort of event you would like to hold here, send a
calendar invitation to
<tt>gsc268k1lu78lbvfbhphdr0cs4@group.calendar.google.com</tt>. For
example, you can add that email address as a guest for an event in
Google Calendar.  By default, events are not password-protected. If
you would like to require a password, enter one: <input
id=reservePassword></input>.  <span
id=reservePasswordInstructions>Include <span
id=reserveEncodedPassword></span> in the description field of your
calendar event.  You and your guests will need to enter the password
exactly as you typed it.</span>

<p>

Let your guests know in advance they'll need:

<ul>
<li>A computer (not a phone or tablet)
<li>Chrome or Firefox
<li>Ideally, wired headphones.  For multiple people, headphone splitters are ~$5 and work well (<a href="https://smile.amazon.com/Belkin-Speaker-and-Headphone-Splitter/dp/B00009WQSR/">2-way</a>, <a href="https://smile.amazon.com/AmazonBasics-5-Way-Headphone-Splitter-5-Pack/dp/B0719LFLKG/">5-way</a>).
</ul>

</div>

<iframe id=calendar src="https://calendar.google.com/calendar/u/0/embed?src=gsc268k1lu78lbvfbhphdr0cs4@group.calendar.google.com"></iframe>
</div>
</div>

<div id=about class=middlePane>
<div style="max-width: 40em">

Bucket Brigade is a program for making music over the Internet. <a
href="https://github.com/gwillen">Glenn</a>, <a
href="https://www.jefftk.com">Jeff</a>, and <a
href="https://github.com/gwillen/solstice-audio-test/graphs/contributors">others</a>
develop and maintain it on a "best effort" basis.

<p>

It is free to use, but does cost ~<a
href="https://www.twilio.com/video/pricing">25&cent;/person/hour</a>
to run.  If you end up using it much, it would be nice if you would
send us a small amount of money to cover server expenses: <a
href="https://paypal.me/jefftkaufman">paypal.me/jefftkaufman</a>.

<p>

The code is <a
href="https://github.com/gwillen/solstice-audio-test/">open
source</a>, and if you would be interested in running your own
instance we'd be happy to help you get set up.  It is also possible to
use as a library, and in that form it has handled an event with <a
href="https://www.jefftk.com/p/secular-solstice-2020">over 200
users</a>.

<p>

If you have questions, <a
href="https://github.com/gwillen/solstice-audio-test/issues/new">file
an issue</a> or write to <tt>bucketbrigade@googlegroups.com</tt>.

<h2>Troubleshooting</h2>

<h3>Someone is much too quiet during songs</h3>

Volume levels during songs are separate from volume levels while
talking, so someone can be a normal volume in the video call portion
but too quiet while singing.  This often happens if someone
accidentally makes an uncharacteristically loud noise, or switches
microphones.  They should refresh the page and recalibrate.

<h3>Someone is consistently off the beat by the same amount.</h3>

If someone is consistently a fraction of a beat early or late, their
client side latency adjustment has gotten off. Most likely, they
switched microphones or headphones without recalibrating.  They should
refresh the page and recalibrate.

<p>

On the other hand, if someone is in consistently off the beat, sometimes
early and sometimes late, they are probably just not singing/playing their
best.  They could mute their mic or move to a late bucket.

<p>

Figuring out which of these is going on is awkward.  Please be kind to
each other!  A good default is to recalibrate if in doubt, to quickly
rule out a technical problem.

<h3>I keep seeing "Due to lag, your singing is not included"</h3>

This happens most often if your computer is overloaded. Try closing
other things running on your computer, including background tabs.

<h3>I can't figure out how to upload a backing track</h3>

Currently, the only way to upload a backing track is to email it to me
and I can upload it: <tt>jeff.t.kaufman@gmail.com</tt>.  This is
silly, and I should make it better. Tracking this in <a
href="https://github.com/gwillen/solstice-audio-test/issues/89">Issue
89</a>.</a>

<h3>Something else weird is going on</h3>

If you'd like Jeff to drop into your call and have a look, you're
welcome to text 617-871-0237 between 8am and 10pm.  This is best
effort; I'll come if I'm not busy.

<p>

Alternatively, fill out the form <a
href="https://github.com/gwillen/solstice-audio-test/issues/new">on
github</a>.  Please give as much information as you can, so I can try
and trigger your problem and figure out why it wasn't doing what it
should.

</div>
</div>

<div id=noAudioWorklet  class=middlePane>
  <div>
  It looks like you're not using Chrome or Firefox.  Unfortunately,
  this doesn't yet work in other browsers because they don't have AudioWorklet.

  <p>

  While we don't recommend trying to continue anyway, because it will
  probably fail silently and just be frustrating for you, if you want
  you can continue:

    <button id=dismissNoAudioWorklet>dismiss</button>
  </div>
</div>

<div id=isMobile class=middlePane>
  <div>

  It looks like you are on a mobile browser. This is not recommended:
  we haven't found any mobile devices that are able to keep up with
  the strain of encoding and decoding audio in JavaScript.

  <p>

  While we don't recommend trying to continue anyway, because it will
  probably fail silently and just be frustrating for you, if you want
  you can continue:

    <button id=dismissIsMobile>dismiss</button>
  </div>
</div>

<div id=debugInfo class=middlePane>
<div>
  Sample rate:
  <input type=text id=sampleRate value="(not available yet)" disabled>
<br>
  Input / output peak absolute amplitude:
  <input type=text id=peakIn value="(not available yet)" disabled>
  <input type=text id=peakOut value="(not available yet)" disabled>
<br>
  Input gain (scalar):
  <input type=text id=inputGain value="(not available yet)" disabled>
<br>
  This client total time consumed (s):
  <input type=text id=clientTotalTime value="(not available yet)" disabled>
<br>
  This client read slippage (s):
  <input type=text id=clientReadSlippage value="(not available yet)" disabled>
<br>
  Total time to next client [more than 3 is bad] (s):
  <input type=text id=clientTimeToNextClient value="(not available yet)" disabled>
<br>
  Batch size (ms):
  <input type=text id=msBatchSize value="(not available yet)" disabled>
<br>
  Client Latency (ms):
  <input type=text id=msClientLatency value="(not available yet)" disabled>
<br>
  Web Audio Jank (initial) (ms):
  <input type=text id=msWebAudioJank value="(not available yet)" disabled>
<br>
  "True" (de-janked) Latency (ms):
  <input type=text id=msTrueLatency value="(not available yet)" disabled>
<br>
  Web Audio Jank (current) (ms):
  <input type=text id=msWebAudioJankCurrent value="(not available yet)" disabled>
</div>
</div>


<div id=middle class=middlePane>

<div id="roomfull">
  We're sorry, the room is currently full.  Please try again later!
</div>

<div id=tutorial>
  <div id=tutorial_questions>
    Welcome!  This is a program for singing with people over the
    Internet. <span id=eventWelcome></span>

    <p>
    <br>

    Before we start, a few questions:

    <p>

    <div id=q_name>
      What's your name? <input id=userName></input>
      <button>Enter</button>
      <div id=needName>* we need to know what to call you</div>
    </div>

    <div id=q_password>
      What's the password for this event? <input id=enteredPassword></input>
      <button>Enter</button>
      <div id=wrongPassword>* that is not the password.  If you were invited,
           please check in with the organizer.</div>
    </div>

    <div id=q_singing_listening>
      Are you planning on singing or just listening?
      <button>Singing and Listening</button>
      <button>Only Listening</button>
    </div>
    <div id=q_headphones_present>
      Are you using headphones?
      <button>Yes</button>
      <button>No</button>
    </div>

    <div id=q_wired_headphones_available>
      Do you have wired headphones that you could easily use?
      <button>Yes</button>
      <button>No</button>
    </div>

    <div id=q_headphones_wired>
      Are your headphones wired?
      <button>Yes</button>
      <button>No</button>
    </div>
  </div>

  <div id=final_attach_wired>
    Great! Please attach them and then refresh this page.
  </div>

  <div id=final_no_headphones>
    That's OK! Using headphones helps reduce noise, but it still works OK
    if a few people aren't wearing headphones.
    <button class=dismiss_tutorial>Get Started</button>
  </div>

  <div id=final_detach_wireless>
    Wireless headphones have large and inconsistent latency.  Please
    detach them and refresh this page.
  </div>

  <div id=final_wired_headphones>
    Wired headphones are ideal!
    <p>
    <button class=dismiss_tutorial>Get Started</button>
  </div>
</div>

<div id=chooseCamera>
Last step!  We just need to sort out cameras.

<div id=noCameraFound>No camera found</div>
<p>
<button id=nextCamera>Switch camera</button>
<button id=chosenCamera>Use this camera</button>
<button id=noCamera>Continue without camera</button>
<p>
<div id=cameraPreview><span>loading...</span></div>
</div>

<div id=mainApp>

<div id=inputSelector>
Input device:
  <select id=inSelect disabled=true>
    <option>Loading...</option>
  </select>
</div>

<div id=latencyCalibrationInstructions>

<p>

In the next step we are going to need to make some really loud beeps to
calibrate latency.

  <p>

Please turn your volume all the way up.
<span class=headphoneAdvice>
Take your headphones off your head, and position the earpieces as
close as possible to your mic.  On a mac laptop this is near the "esc"
key.</span>  Press "start" when ready.

</div>

<div id=rememberedCalibrationInstructions>
<p>

If you've changed something about your audio setup since your last
visit, press "recalibrate".  Otherwise press "start" to begin.

<p>

<button id=recalibrate>Recalibrate</button>

</div>

<button id=startButton></button>

<div id=calibration>

<div id=autoCalibrate1>
  You should be hearing some beeps.

  <ul>
    <li>If you don't hear anything, is your speaker unmuted?
    <li>If you do hear beeps but <tt>#beeps detected</tt> is not counting up,
      turn up the volume.
    <li>If the beeps are very loud but it's still not counting up,
      try refreshing the page and changing your input device.
    <li>Other things to try:
    <ul>
      <li>Restarting your browser.
      <li>Restarting your computer.
      <li>Switching from Chrome to Firefox or vice-versa.
      <li>Refreshing the page and choosing "Only Listening" to skip calibration.
    </ul>
  </ul>
</div>

<div id=noAudioInputInstructions class=warning>
Mic producing any audio. Is your input device set correctly?
</div>


<p>

  <div id=estQuality>
    <center>
  <div id=latencyCalibrationFailed>

Unable to calibrate latency. Please make sure that the microphone is
able to hear the speaker.
<br>
<br>
<button id=latencyCalibrationRetry>Retry</button>
<button id=latencyCalibrationGiveUp>Continue Without Calibration</button>
<br>
<br>

It's fine to continue without calibration if you just to sing along,
but your audio can't be sent out for everyone else to hear unless we
know exactly how much client-side latency you have.

  </div>

    <span id=estSamples>...</span><br>
    #beeps detected

    <span id=estLatency>...</span><br>
    latency<br>
    <br>

    <span id=est25to75>...</span><br>
    variance
    </center>
  </div>



<p>

Click volume: <input id=clickVolumeSlider type=range min=0 max=100
value=100>

</div>

</div>

<div id=volumeCalibration>
  Your latency is now calibrated!  If it any point you change
  something about your audio setup, such as switching to a different
  microphone, please refresh the page and recalibrate.

  <p>

  Now we need to calibrate your volume. You probably want to turn your
  speaker volume back down.  Pick something you're comfortable
  singing, start singing, and then click <button
  id=startVolumeCalibration>I've begun singing</button>.

  <p>

  <div id=reportVolume>
    Volume: <span id=reportedVolume>...</span>
  </div>

</div>
<div id=mainInterface>

<div id=acrossTop>
  <div class=warning id=lostConnectivity>
    Lost connectivity to the server. Trying to reconnect&hellip;
  </div>

  <div class=warning id=timeoutImminent>
    Are you still here? If so, move the mouse or something.
  </div>

  <div>
    <button id=takeLead>Lead a Song</button>
    <button id=provideLyrics>Provide Lyrics</button>
    <select id=backingTrack></select>
    <div id=runningStatus></div>
  </div>

  <div id=lagmute>
    <span>Due to lag, your singing is not included</span>
    <button id=unlagmute>Try Again</button>
  </div>
</div>

<div id=bucketsAndChat>

<div id=remainderWindow>

<div id=aboveBuckets>
  <div id=bucketingGuide>

    Each person is in a bucket. You can hear the people in earlier
    buckets, and you can be heard by the people in later buckets. You
    can't hear other people in your own bucket.  You can move between
    buckets by pressing the "join" button in the upper right.

    <p>

    If you are a strong singer or know the song well you might choose
    an earlier bucket, while if you are less confident you might
    choose a later one.  Similarly, if you are in a noisy environment
    or are not wearing headphones, you might also choose a later one.

  </div>

  <textarea id=lyricsDisplay>
  Lyrics Go Here
  </textarea>
</div>



<div id=buckets></div>
<div id=unbucketedUsers></div>

</div> <!-- remainderWindow -->

<div id=chatWindow>
  <div id=chatDisplay></div>
  <form id=chatForm><input type="text" id=chatEntry></input><input type="submit" id=chatPost value="Post"></input></form>
</div>

</div> <!-- bucketsAndChat -->

</div>
</div>

<div id=controlbar>
  <div>
    <button disabled id=micToggleButton>mute mic</button>
    <button disabled id=speakerToggleButton>mute speaker</button>
    <button disabled id=videoToggleButton>...</button>
    <div id=spectatorMode>As a spectator, your singing is not included</div>
  </div>

  <div>
  <label for=backingVolumeSlider>Backing Volume:</label>
  <input type="range" min="0" max="160" value="100" id="backingVolumeSlider">
  </div>

  <div>
    <input id=changeName></input>
    <button id=changeNameButton>Update</button>
  </div>

  <!-- DELAY_INTERVAL * LAYERING_DEPTH -->
  <div>Time Travel: <input type=text id=audioOffset value="18">s</div>
</div>

</div>

</div>

<div id="crash">
  <h1 id="crashMessage">This app has crashed. We're really sorry :-(</h1>
  <div id="crashBug">
    <h2>Please <a href="https://github.com/gwillen/solstice-audio-test/issues/new">file a bug</a> with the following information; it will help us fix it.</h2>
    <textarea id="crashTrace" rows="50" cols="160" readonly></textarea>
    <h2>Then refresh the page and try again.</h2>
  </div>
</div>

<script>
  let showingWarningPane = true;

  if (window.AudioWorklet) {
    window.noAudioWorklet.style.display = "none";
    window.middle.style.display = "block";

    // We only need to check for Android, because no other mobile
    // device supports audio worklet.
    if (navigator.userAgent.match(/Android/i)) {
      window.isMobile.style.display = "block";
      window.middle.style.display = "none";
    } else {
      showingWarningPane = false;
    }
  }

  const middlePanes = {
    "Main": window.middle,
    "DebugSettings": window.debugSettings,
    "DebugInfo": window.debugInfo,
    "Reserve": window.booktime,
    "About": window.about,
    "AdvancedSettings": window.advancedSettings,
    "UnsupportedBrowser": window.noAudioWorklet,
    "UnsupportedDevice": window.isMobile,
  };

  const tabs = {
    "Main": window.mainViewTab,
    "DebugSettings": window.debugSettingsTab,
    "DebugInfo": window.debugInfoTab,
    "Reserve": window.booktimeTab,
    "About": window.aboutTab,
    "AdvancedSettings": window.advancedSettingsTab,
  };

  for (const [paneName, paneTab] of Object.entries(tabs)) {
    paneTab.addEventListener("click", () => {
      showPane(paneName);
    });
  }

  for (dismiss of [window.dismissNoAudioWorklet, window.dismissIsMobile]) {
    dismiss.addEventListener(
      "click", () => {
        showPane("Main");
      });
  }

  function showPane(paneName) {
    for (const [otherPaneName, otherPaneDiv] of Object.entries(middlePanes)) {
      otherPaneDiv.style.display = "none";
    }
    for (const [otherPanelName, otherPanelTab] of Object.entries(tabs)) {
      otherPanelTab.classList.remove("activeTab");
    }
    middlePanes[paneName].style.display = "block";
    if (tabs[paneName]) {
      tabs[paneName].classList.add("activeTab");
    }
    window.location.hash = (paneName === "Main" ? "" : paneName);
  }

  if (window.location.hash && !showingWarningPane) {
    const paneName = window.location.hash.substring(1);
    if (paneName in tabs) {
      showPane(paneName);
    }
  }
</script>

<script type="module" src="./demo.js"></script>

</html>
